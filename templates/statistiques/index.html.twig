{% extends 'base.html.twig' %}

{% block title %}Statistiques - Kar&Go{% endblock %}

{% block body %}
<div class="container-fluid px-4 py-4" style="padding-top: 100px;">
    
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-2">
                <i class="fas fa-chart-line text-primary"></i>
                Statistiques de la plateforme
            </h1>
            <p class="text-muted">Vue d'ensemble des performances</p>
        </div>
        <a href="{{ path('app_admin_dashboard') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Retour au panneau admin
        </a>
    </div>

    <!-- Cartes de statistiques principales -->
    <div class="row g-4 mb-4">
        <!-- Réservations -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm bg-gradient-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-2">Total Réservations</h6>
                            <h2 class="mb-0">{{ stats.reservations.total }}</h2>
                            <small>
                                <i class="fas fa-check-circle"></i> {{ stats.reservations.confirmees }} confirmées
                            </small>
                        </div>
                        <div class="stat-icon-large">
                            <i class="fas fa-ticket-alt fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Revenu -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm bg-gradient-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-2">Revenu Total</h6>
                            <h2 class="mb-0">{{ revenu_total|number_format(2, '.', ' ') }} TND</h2>
                            <small>Réservations confirmées</small>
                        </div>
                        <div class="stat-icon-large">
                            <i class="fas fa-coins fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Utilisateurs -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm bg-gradient-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-2">Utilisateurs</h6>
                            <h2 class="mb-0">{{ stats.utilisateurs.total }}</h2>
                            <small>Inscrits sur la plateforme</small>
                        </div>
                        <div class="stat-icon-large">
                            <i class="fas fa-users fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bus -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm bg-gradient-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-2">Flotte de Bus</h6>
                            <h2 class="mb-0">{{ stats.bus.total }}</h2>
                            <small>
                                <i class="fas fa-check"></i> {{ stats.bus.disponibles }} disponibles
                            </small>
                        </div>
                        <div class="stat-icon-large">
                            <i class="fas fa-bus fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiques détaillées -->
    <div class="row g-4 mb-4">
        <!-- Graphique réservations par mois -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar text-primary"></i>
                        Évolution des réservations (6 derniers mois)
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="reservationsChart" height="80"></canvas>
                </div>
            </div>
        </div>

        <!-- Statistiques par catégorie -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle text-primary"></i>
                        Détails
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Chauffeurs -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-2">Chauffeurs</h6>
                        <div class="d-flex justify-content-between mb-1">
                            <span>Total</span>
                            <strong>{{ stats.chauffeurs.total }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span><i class="fas fa-circle text-success"></i> Actifs</span>
                            <span>{{ stats.chauffeurs.actifs }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span><i class="fas fa-circle text-danger"></i> Inactifs</span>
                            <span>{{ stats.chauffeurs.inactifs }}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-circle text-warning"></i> En congé</span>
                            <span>{{ stats.chauffeurs.en_conge }}</span>
                        </div>
                    </div>

                    <hr>

                    <!-- Horaires -->
                    <div>
                        <h6 class="text-muted mb-2">Horaires</h6>
                        <div class="d-flex justify-content-between mb-1">
                            <span>Total</span>
                            <strong>{{ stats.horaires.total }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span><i class="fas fa-circle text-success"></i> Actifs</span>
                            <span>{{ stats.horaires.actifs }}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-circle text-danger"></i> Inactifs</span>
                            <span>{{ stats.horaires.inactifs }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dernières réservations -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white">
            <h5 class="mb-0">
                <i class="fas fa-history text-primary"></i>
                Dernières réservations
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>N° Réservation</th>
                            <th>Passager</th>
                            <th>Trajet</th>
                            <th>Date</th>
                            <th>Montant</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for reservation in dernieres_reservations %}
                            <tr>
                                <td><strong class="text-primary">{{ reservation.numeroReservation }}</strong></td>
                                <td>{{ reservation.passager.nom }} {{ reservation.passager.prenom }}</td>
                                <td>
                                    {{ reservation.horaire.trajet.villeDepart }}
                                    <i class="fas fa-arrow-right text-muted"></i>
                                    {{ reservation.horaire.trajet.villeArrivee }}
                                </td>
                                <td>{{ reservation.dateReservation|date('d/m/Y H:i') }}</td>
                                <td><strong>{{ reservation.montant }} TND</strong></td>
                                <td>
                                    {% if reservation.statut == 'confirmee' %}
                                        <span class="badge bg-success">Confirmée</span>
                                    {% else %}
                                        <span class="badge bg-danger">Annulée</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="6" class="text-center py-4 text-muted">
                                    Aucune réservation récente
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .bg-gradient-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    .bg-gradient-info {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
    }
    .bg-gradient-warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    .card {
        border-radius: 12px;
    }
</style>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('reservationsChart');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ reservations_par_mois|map(r => r.mois)|json_encode|raw }},
            datasets: [{
                label: 'Nombre de réservations',
                data: {{ reservations_par_mois|map(r => r.count)|json_encode|raw }},
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
</script>
{% endblock %}